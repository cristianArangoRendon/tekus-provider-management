<div class="page-container">
  <mat-toolbar class="app-toolbar">
    <div class="toolbar-content">
      <div class="left-section">
        <button mat-icon-button class="back-btn" (click)="cancel()">
          <mat-icon>arrow_back</mat-icon>
        </button>
        <div class="breadcrumb">
          <span class="parent">Proveedores</span>
          <mat-icon class="separator">chevron_right</mat-icon>
          <span class="current">{{ isEditMode ? 'Editar' : 'Nuevo' }}</span>
        </div>
      </div>
    </div>
  </mat-toolbar>

  <div class="content-wrapper">
    <div class="custom-card form-card">
      <div class="card-header">
        <div class="header-icon">
          <mat-icon>{{ isEditMode ? 'edit' : 'add_business' }}</mat-icon>
        </div>
        <div class="header-text">
          <h1>{{ isEditMode ? 'Editar Proveedor' : 'Registrar Proveedor' }}</h1>
          <p>Complete la información básica y configure los atributos adicionales.</p>
        </div>
      </div>

      <form [formGroup]="providerForm" (ngSubmit)="onSubmit()">
        <div class="card-body">
          <div class="form-section">
            <h3>Información General</h3>
            <div class="input-grid">
              <div class="field-wrapper">
                <mat-label class="custom-label">Nombre de la Empresa</mat-label>
                <mat-form-field appearance="outline" class="custom-field">
                  <input matInput formControlName="providerName" placeholder="Ej. Tech Solutions SAS">
                  <mat-icon matPrefix>business</mat-icon>
                  @if (providerForm.get('providerName')?.hasError('required')) {
                    <mat-error>El nombre es requerido</mat-error>
                  }
                </mat-form-field>
              </div>

              <div class="field-wrapper">
                <mat-label class="custom-label">NIT / Identificación</mat-label>
                <mat-form-field appearance="outline" class="custom-field">
                  <input matInput formControlName="nit" placeholder="Ej. 900123456-1" maxlength="11">
                  <mat-icon matPrefix>badge</mat-icon>
                  @if (providerForm.get('nit')?.hasError('pattern')) {
                    <mat-error>Formato inválido (Ej: 123456789-0)</mat-error>
                  }
                </mat-form-field>
              </div>

              <div class="field-wrapper full-width">
                <mat-label class="custom-label">Correo Electrónico</mat-label>
                <mat-form-field appearance="outline" class="custom-field">
                  <input matInput type="email" formControlName="email" placeholder="contacto@empresa.com">
                  <mat-icon matPrefix>mail_outline</mat-icon>
                  @if (providerForm.get('email')?.hasError('email')) {
                    <mat-error>Ingrese un correo válido</mat-error>
                  }
                </mat-form-field>
              </div>
            </div>
          </div>

          <div class="divider"></div>

          <div class="form-section">
            <div class="section-header">
              <h3>Campos Personalizados</h3>
              <span class="badge-info">Opcional</span>
            </div>

            <div class="add-field-container" [formGroup]="customFieldForm">
              <div class="inline-inputs">
                <mat-form-field appearance="outline" class="dense-field">
                  <mat-label>Nombre del campo</mat-label>
                  <input matInput formControlName="fieldName" placeholder="Ej. Ciudad">
                </mat-form-field>

                <mat-form-field appearance="outline" class="dense-field">
                  <mat-label>Valor</mat-label>
                  <input matInput formControlName="fieldValue" placeholder="Ej. Medellín">
                </mat-form-field>

                <button 
                  mat-icon-button 
                  class="add-btn" 
                  type="button" 
                  (click)="addCustomField()"
                  [disabled]="customFieldForm.invalid"
                  matTooltip="Agregar a la lista">
                  <mat-icon>add_circle</mat-icon>
                </button>
              </div>
            </div>

            @if (customFieldsList.length > 0) {
              <div class="fields-list">
                @for (field of customFieldsList; track $index; let i = $index) {
                  <div class="field-row">
                    <div class="row-content">
                      <div class="field-icon">
                        <mat-icon>label</mat-icon>
                      </div>
                      <div class="field-data">
                        <span class="key">{{ field.fieldName }}</span>
                        <span class="value">{{ field.fieldValue }}</span>
                      </div>
                    </div>
                    <button mat-icon-button color="warn" type="button" (click)="removeCustomField(i)">
                      <mat-icon>delete_outline</mat-icon>
                    </button>
                  </div>
                }
              </div>
            } @else {
              <div class="empty-fields">
                <p>No hay campos adicionales configurados.</p>
              </div>
            }
          </div>
        </div>

        <div class="card-footer">
          <button type="button" class="cancel-btn" (click)="cancel()">
            Cancelar
          </button>
          <button type="submit" class="submit-btn" [disabled]="providerForm.invalid || loading">
            @if (loading) {
              <mat-spinner diameter="20"></mat-spinner>
              <span>Guardando...</span>
            } @else {
              <span>{{ isEditMode ? 'Guardar Cambios' : 'Crear Proveedor' }}</span>
              <mat-icon>check</mat-icon>
            }
          </button>
        </div>
      </form>
    </div>
  </div>

  @if (loading) {
    <div class="loading-overlay"></div>
  }
</div>